CREATE DATABASE EXSDB;
USE EXSDB;

CREATE TABLE CARRERA(
        CID SMALLINT NOT NULL AUTO_INCREMENT,
        CNOM VARCHAR(30) NOT NULL,        
        SEDE TINYINT NOT NULL,
        PRIMARY KEY (CID)
) ENGINE  = InnoDB;


CREATE TABLE ESTUDIANTE(
        ID VARCHAR(15) NOT NULL,
        NOM VARCHAR(30) NOT NULL,
        PAPE VARCHAR(30) NOT NULL,
        SAPE VARCHAR(30) NOT NULL,
        GENERO NUMERIC(2) NOT NULL,
        TEL NUMERIC(15)  NOT NULL,
        CEL NUMERIC(15)  NOT NULL,
        EMAIL VARCHAR(256)  NOT NULL,	
        CID SMALLINT NOT NULL,
        SEDE TINYINT NOT NULL,
        BECA TINYINT NOT NULL,
        PRIMARY KEY (ID),
        FOREIGN KEY (CID) REFERENCES CARRERA(CID)
) ENGINE  = InnoDB;


CREATE TABLE TUTOR(
        ID VARCHAR(15) NOT NULL,
        NOM VARCHAR(30) NOT NULL,
        PAPE VARCHAR(30) NOT NULL,
        SAPE VARCHAR(30) NOT NULL,
        GENERO NUMERIC(2) NOT NULL,        
        TEL NUMERIC(15)  NOT NULL,
        EMAIL VARCHAR(256)  NOT NULL,	
        PRIMARY KEY (ID)       
) ENGINE  = InnoDB;

CREATE TABLE TUTORIA(
    COD VARCHAR(15) NOT NULL,
    NOM VARCHAR(30) NOT NULL,
    PRIMARY KEY (COD)
) ENGINE  = InnoDB;


CREATE TABLE GRUPO(
    NUM VARCHAR(25) NOT NULL,
    TID VARCHAR(15) NOT NULL,
    TCOD VARCHAR(15) NOT NULL,
    LUGAR VARCHAR(35) NOT NULL,
    ANIO SMALLINT NOT NULL,
    CICLO TINYINT NOT NULL,
    HORARIO VARCHAR(5) NOT NULL,
    ESTADO VARCHAR(15) NOT NULL,
    PRIMARY KEY (NUM),
    FOREIGN KEY (TID) REFERENCES TUTOR(ID),
    FOREIGN KEY (TCOD) REFERENCES TUTORIA(COD)
) ENGINE  = InnoDB;





CREATE TABLE MATRICULA(
        EID VARCHAR(15) NOT NULL,
        GNUM VARCHAR(25) NOT NULL,
        FECHA DATE NOT NULL,        
        ESTADO VARCHAR(25) NOT NULL,
        NOTA NUMERIC(2,2) NOT NULL,
        NRC INT NOT NULL,
        VECES TINYINT NOT NULL,
        FOREIGN KEY (EID) REFERENCES ESTUDIANTE(ID),
        FOREIGN KEY (GNUM) REFERENCES GRUPO(NUM),
        PRIMARY KEY (EID,GNUM)
) ENGINE  = InnoDB;


CREATE TABLE RETIRARON(
    EID VARCHAR(15) NOT NULL,
    FECHAMATRICULA DATE NOT NULL, 
    FECHARETIRO DATE NOT NULL, 
    TUTORIACOD VARCHAR(25) NOT NULL,
    MOTIVO VARCHAR(1000) NOT NULL,
    FOREIGN KEY (EID) REFERENCES ESTUDIANTE(ID),
    FOREIGN KEY (TUTORIACOD) REFERENCES TUTORIA(COD),
    PRIMARY KEY (EID,TUTORIACOD)
)ENGINE  = InnoDB;


CREATE TABLE CLASE(
        CLID INT NOT NULL AUTO_INCREMENT,
        GNUM VARCHAR(25) NOT NULL,
        FECHA DATE NOT NULL,        
        OBSRV TEXT, 
        PRIMARY KEY (CLID),
        FOREIGN KEY (GNUM) REFERENCES GRUPO(NUM)
) ENGINE  = InnoDB;


CREATE TABLE ASISTENCIA(
        EID VARCHAR(15) NOT NULL,
        CLID INT NOT NULL,
        ESTADO VARCHAR(15) NOT NULL,
        FOREIGN KEY (EID) REFERENCES ESTUDIANTE(ID),
        FOREIGN KEY (CLID) REFERENCES CLASE(CLID),
        PRIMARY KEY (EID,CLID)
) ENGINE  = InnoDB;


delimiter //
CREATE PROCEDURE CUPOS_P (IN PNUM VARCHAR(25))
BEGIN
    DECLARE CANT_ACTIVOS TINYINT; 
    SELECT COUNT(*) INTO CANT_ACTIVOS
        FROM MATRICULA WHERE GNUM = PNUM AND ESTADO = 'Activo';
    IF   CANT_ACTIVOS >= 15   THEN 
        UPDATE GRUPO SET ESTADO = 'Sin Cupo' WHERE NUM = PNUM;
    END IF;  
END//
delimiter ;


delimiter //
CREATE TRIGGER CUPOS_INSERT AFTER INSERT ON MATRICULA  
FOR EACH ROW 
BEGIN
   CALL CUPOS_P ( NEW.GNUM );
END//
delimiter ;


delimiter //
CREATE TRIGGER CUPOS_UPDATE AFTER UPDATE ON MATRICULA  
FOR EACH ROW 
BEGIN
   CALL CUPOS_P ( NEW.GNUM );
END//
delimiter ;





ALTER TABLE CARRERA MODIFY CNOM VARCHAR(100); 
		
		
DROP TRIGGER CUPOS_INSERT;
DROP TRIGGER CUPOS_UPDATE;
DROP PROCEDURE CUPOS_P;


DROP TABLE ASISTENCIA;
DROP TABLE CLASE;
DROP TABLE MATRICULA;


DROP TABLE GRUPO;

DROP TABLE TUTOR;
DROP TABLE TUTORIA;

DROP TABLE ESTUDIANTE;
DROP TABLE CARRERA;



